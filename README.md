# Проект [RateYourMusic](https://rateyourmusic.com/) Database

## Описание

Этот проект представляет собой учебную реляционную базу данных PostgreSQL, предназначенную для хранения и управления информацией о музыкальных исполнителях, релизах, треках, жанрах и пользовательских оценках. База данных включает реализацию версионирования данных пользователей (SCD Type 2), а также набор SQL-функций, процедур, триггеров и представлений для расширенной работы с данными. Дополнительно, проект содержит Python-скрипт для генерации тестовых данных, их анализа и визуализации.

## Ключевые Возможности

*   **Реляционная модель данных:** Продуманная схема для хранения музыкальной информации.
*   **Версионирование данных пользователей:** Таблицы `Users` и `UsersArchive` для отслеживания изменений (SCD Type 2).
*   **Дополнительный SQL-функционал:**
    *   Функции для получения иерархии жанров и дискографии артистов.
    *   Процедура для атомарного добавления релиза вместе с треками.
    *   Триггеры для автоматического архивирования данных пользователя, проверки корректности номеров треков и установки даты регистрации.
    *   Представления для получения агрегированных данных, таких как топ релизов и активных пользователей.
*   **Индексы:** Оптимизация запросов с помощью различных типов индексов.
*   **Примеры SQL-запросов:** Демонстрация возможностей СУБД для анализа данных.
*   **Аналитика и Визуализация:** Python-скрипт (`py/analysis.py`) для:
    *   Генерации расширенного набора данных.
    *   Анализа данных с использованием `pandas` и `SQLAlchemy`.
    *   Визуализации результатов с помощью `matplotlib`.
    *   Проверки статистических гипотез с `scipy`.

## Структура Базы Данных

![Логическая модель БД](https://raw.githubusercontent.com/KotovBoris/rym-db/main/dosc/logic_model.png)

База данных включает следующие основные таблицы:

*   **`Genres`**: Жанры музыки и их иерархия.
*   **`Artists`**: Информация об исполнителях и музыкальных группах.
*   **`Releases`**: Релизы (альбомы, синглы, EP) музыкальных исполнителей.
*   **`Tracks`**: Треки, входящие в релизы.
*   **`Users`**: Актуальная информация о пользователях.
*   **`UsersArchive`**: Архивная информация о пользователях, история изменений (SCD Type 2).
*   **`Ratings`**: Оценки и отзывы пользователей для релизов.
*   **`TracksGenres`**: Связующая таблица для связи "многие-ко-многим" между треками и жанрами.
*   **`TracksArtists`**: Связующая таблица для связи "многие-ко-многим" между треками и артистами.

Подробное описание каждой таблицы, её полей, типов данных и ограничений находится в файле `docs/physical_model.md`.

## SQL-скрипты

Все SQL-скрипты находятся в директории `sql-scripts/`.

*   **`create_rym_db.sql`**: Создание всех таблиц базы данных с их ограничениями и связями.
*   **`clear_db.sql`**: Удаление всех таблиц из базы данных (для очистки перед пересозданием).
*   **`fill_data.sql`**: Заполнение таблиц небольшим набором начальных тестовых данных.
*   **`func.sql`**:
    *   `GetSubgenres(p_RootGenreName)`: Функция для получения всех поджанров указанного родительского жанра.
    *   `AddReleaseWithTracks(...)`: Процедура для добавления нового релиза и всех его треков в одной транзакции.
    *   `GetArtistDiscography(p_ArtistId)`: Функция для получения дискографии артиста со средними оценками релизов.
*   **`triggers.sql`**:
    *   `fn_ArchiveUserChanges()` и `trg_ArchiveUserChanges`: Триггер для автоматического архивирования изменений данных пользователя в `UsersArchive` при обновлении записи в `Users`.
    *   `fn_CheckTrackNumber()` и `trg_CheckTrackNumber`: Триггер для проверки корректности (положительность, уникальность в рамках релиза) номера трека (`NumberInRelease`) при вставке или обновлении.
    *   `fn_SetUserRegistrationDate()` и `trg_SetUserRegistrationDate`: Триггер для автоматической установки текущей даты регистрации пользователя, если она не указана.
*   **`views.sql`**:
    *   `TopCurrentReleases`: Представление, отображающее релизы с их средним рейтингом, количеством голосов и доминирующим жанром, отсортированные по популярности.
    *   `TopActiveUsers`: Представление, отображающее пользователей с количеством написанных ими рецензий и их средним рейтингом, отсортированные по активности.
*   **`indexes.sql`**: Скрипт для создания индексов (HASH) для оптимизации запросов к таблицам `TracksArtists`, `TracksGenres`, `Tracks` и `UsersArchive`.
*   **`examples.sql`**: Набор из 11+ примеров SQL-запросов для демонстрации различных способов извлечения и анализа данных, включая использование `JOIN`, подзапросов, оконных функций и `EXISTS`.
*   **`simple_tests/`**: Директория с простыми скриптами для проверки работоспособности функций и представлений.

## Анализ и Визуализация Данных (Python)

Скрипт `py/analysis.py` выполняет следующие задачи:

1.  **Очистка и Подготовка БД**: Полностью очищает существующие данные и таблицы (аналогично `clear_db.sql` + `TRUNCATE`).
2.  **Генерация Данных**: Использует библиотеку `Faker` для генерации расширенного набора тестовых данных (1000 пользователей, 500 релизов, 5000 оценок и т.д.), включая вызов процедуры `AddReleaseWithTracks`.
3.  **Извлечение и Агрегация**: С помощью `SQLAlchemy` и `pandas` выполняет SQL-запросы для агрегации данных (например, средний рейтинг по жанрам, количество релизов по годам).
4.  **Визуализация**: Строит графики на основе полученных данных с использованием `matplotlib` (распределение оценок, число релизов по годам, средний рейтинг по жанрам).
5.  **Проверка Гипотез**: Формулирует и проверяет статистические гипотезы с использованием `scipy.stats` (например, различие средних рейтингов между жанрами, корреляция между количеством треков и рейтингом).

## Установка и Запуск

1.  **Необходимые условия:**
    *   Установленная СУБД PostgreSQL.
    *   Python 3.x с установленными библиотеками: `psycopg2-binary`, `SQLAlchemy`, `pandas`, `matplotlib`, `Faker`, `numpy`, `scipy`.
    Установить зависимости можно командой:
    ```bash
    pip install psycopg2-binary SQLAlchemy pandas matplotlib Faker numpy scipy
    ```
2.  **Настройка подключения к БД:**
    *   В скрипте `py/analysis.py` отредактируйте словарь `DB_CONFIG` в соответствии с вашими параметрами подключения к PostgreSQL.
3.  **Создание и наполнение базы данных:**
        1.  Выполните `sql-scripts/create_rym_db.sql` для создания структуры таблиц.
        2.  Выполните `sql-scripts/fill_data.sql` для заполнения таблиц базовым набором данных.
        3.  Выполните `sql-scripts/func.sql`, `sql-scripts/triggers.sql`, `sql-scripts/views.sql`, `sql-scripts/indexes.sql` для создания дополнительных объектов БД.
4.  **Просмотр примеров запросов:**
    *   Запросы из `sql-scripts/examples.sql` можно выполнять в любом SQL-клиенте, подключенном к базе данных.

## Структура Проекта

```
├── docs/
│   └── concept_model.png     # Визуализация таблиц и связей между ними
│   └── logic_model.png       # Визуализация основных сущностей
│   └── physical_model.md     # Детальное описание физической модели БД
├── py/
│   └── analysis.py           # Python-скрипт для генерации данных, анализа и визуализации
├── sql-scripts/
│   ├── clear_db.sql          # Скрипт для очистки БД
│   ├── create_rym_db.sql     # Скрипт для создания таблиц
│   ├── examples.sql          # Примеры SQL-запросов
│   ├── fill_data.sql         # Скрипт для заполнения начальными данными
│   ├── func.sql              # Функции и процедуры
│   ├── indexes.sql           # Создание индексов
│   ├── triggers.sql          # Триггеры
│   ├── views.sql             # Представления
│   └── simple_tests/         # Простые тесты для функций и представлений
│       ├── check_views.sql
│       └── func_tests.sql
└── README.md                 # Этот файл
```
